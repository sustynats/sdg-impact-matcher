<script>
/* ===== SDG Impact-Matcher – KI-Lader für GitHub Pages =====
   - Lädt Transformers.js (UMD, kein ES-Module)
   - Versucht mehrere CDNs
   - Lädt ein kleines Zero-Shot-NLI-Modell (deberta-v3-xsmall/small)
   - Zeigt sauberen Fortschritt & klare Fehlermeldungen
   ========================================================== */

(function(){
  const $=(s,c=document)=>c.querySelector(s);
  const STATUS=$('#sdl-status'), BAR=$('#sdl-bar');

  // ---- UI helpers ----------------------------------------------------------
  function setStatus(txt){ try{ STATUS.textContent=txt; }catch(_){ console.log(txt); } }
  function setProg(p){ try{ BAR.style.width = (p||0)+'%'; }catch(_){}

  // ---- Heuristik, Render etc. bleiben UNVERÄNDERT in deiner Datei ---------
  //  (wir fassen nur das Laden & die Analyse-KI an)
  // -------------------------------------------------------------------------

  // Global state
  let tx = null;         // transformers namespace
  let pipe = null;       // zero-shot pipeline
  let loading = false;

  // 1) Transformers.js per <script> (UMD) laden – mehrere CDNs probieren
  async function loadTransformersUMD(){
    if (window.transformers?.pipeline) return window.transformers;
    const urls = [
      'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.15.0/dist/transformers.min.js',
      'https://unpkg.com/@xenova/transformers@2.15.0/dist/transformers.min.js',
      // konservativer Fallback (älter, dafür stabil)
      'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.14.2/dist/transformers.min.js',
      'https://unpkg.com/@xenova/transformers@2.14.2/dist/transformers.min.js'
    ];
    let lastErr;
    for (const src of urls){
      try{
        setStatus('Lade KI-Bibliothek …');
        await new Promise((res,rej)=>{
          const s=document.createElement('script');
          s.src=src; s.async=true; s.crossOrigin='anonymous';
          s.onload = ()=> window.transformers?.pipeline ? res() : rej(new Error('global not found'));
          s.onerror= ()=> rej(new Error('load error '+src));
          document.head.appendChild(s);
        });
        return window.transformers;
      }catch(e){ lastErr=e; }
    }
    throw lastErr || new Error('Transformers konnte nicht geladen werden.');
  }

  // 2) Modell laden (Zero-Shot). Wir probieren klein → größer → engl. Fallback
  async function ensureModel(){
    if (pipe) return pipe;
    if (loading) { // falls Doppelklicks auf Analysieren
      await new Promise(r=>setTimeout(r,500)); 
      if (pipe) return pipe;
    }
    loading = true;

    tx = await loadTransformersUMD();

    // ONNX/WASM Settings: threads begrenzen, damit es überall läuft
    try{
      tx.env.backends.onnx.wasm.numThreads = Math.max(1, Math.min(3, navigator.hardwareConcurrency||1));
      tx.env.backends.onnx.wasm.proxy = true;
    }catch(_){}

    setStatus('Lade KI-Modell … (einmalig)');
    setProg(12);

    const onProgress = (info)=>{
      if (typeof info?.progress === 'number'){
        // 12 → 92 % während des Downloads
        const p = 12 + Math.round(info.progress * 80);
        setProg(Math.min(92, p));
      }
      if (info?.status){ setStatus('Lade: ' + info.status); }
    };

    // Reihenfolge der Versuche:
    const tries = [
      ['Xenova/nli-deberta-v3-xsmall', 'klein (xsmall)'],
      ['Xenova/nli-deberta-v3-small',  'klein (small)'],
      ['Xenova/distilbert-base-uncased-mnli', 'MNLI (EN Fallback)']
    ];

    let lastErr = null;
    for (const [modelId, label] of tries){
      try{
        setStatus(`Lade Modell ${label} …`);
        pipe = await tx.pipeline('zero-shot-classification', modelId, { progress_callback: onProgress });
        setProg(100);
        setStatus('KI bereit.');
        loading = false;
        return pipe;
      }catch(e){
        console.warn('Modell-Versuch fehlgeschlagen:', modelId, e);
        lastErr = e;
      }
    }

    loading = false;
    throw lastErr || new Error('Kein Modell konnte geladen werden.');
  }

  // 3) Hook an deinen „Analysieren“-Knopf: ersetze NUR die KI-Ladestelle
  const runBtn = document.getElementById('sdl-run');
  const oldHandler = runBtn.onclick; // falls vorher gesetzt
  runBtn.addEventListener('click', async ()=>{
    // Wir setzen hier NUR die Ladephase, die restliche Analyse-Logik deiner Seite bleibt.
    setStatus('Analysiere …');
    setProg(8);
    try{
      await ensureModel();   // <— wichtige Zeile: lädt wirklich das Modell
      // Danach läuft deine existierende Analyse weiter (Zero-Shot + Render)
      // Falls du in deiner Datei schon einen Aufruf wie "const p = await loadModel()" hattest,
      // ersetze ihn durch "await ensureModel()", oder überschreibe loadModel=ensureModel:
      window.loadModel = ensureModel;
      setProg(0); // Fortschrittsbalken zurücksetzen; dein Code zeigt eigenen Fortschritt
    }catch(e){
      console.error(e);
      setStatus('⚠️ KI konnte nicht geladen werden. Prüfe Netzwerk / Adblock / Browser.');
      setProg(0);
    }
  });

  // Optional: schon beim Laden anfangen, die Bibliothek zu cachen (ohne Modell)
  loadTransformersUMD().catch(()=>{});
})();
</script>
